!function($){function RowSelectionModel(options){function init(grid){_options=$.extend(!0,{},_defaults,options),_grid=grid,_handler.subscribe(_grid.onActiveCellChanged,wrapHandler(handleActiveCellChange)),_handler.subscribe(_grid.onKeyDown,wrapHandler(handleKeyDown)),_handler.subscribe(_grid.onClick,wrapHandler(handleClick))}function destroy(){_handler.unsubscribeAll()}function wrapHandler(handler){return function(){_inHandler||(_inHandler=!0,handler.apply(this,arguments),_inHandler=!1)}}function rangesToRows(ranges){for(var rows=[],i=0;i<ranges.length;i++)for(var j=ranges[i].fromRow;j<=ranges[i].toRow;j++)rows.push(j);return rows}function rowsToRanges(rows){for(var ranges=[],lastCell=_grid.getColumns().length-1,i=0;i<rows.length;i++)ranges.push(new Slick.Range(rows[i],0,rows[i],lastCell));return ranges}function getRowsRange(from,to){var i,rows=[];for(i=from;i<=to;i++)rows.push(i);for(i=to;i<from;i++)rows.push(i);return rows}function getSelectedRows(){return rangesToRows(_ranges)}function setSelectedRows(rows){setSelectedRanges(rowsToRanges(rows))}function setSelectedRanges(ranges){ranges&&0!==ranges.length||_grid.resetActiveCell(),_ranges=ranges,_self.onSelectedRangesChanged.notify(_ranges)}function getSelectedRanges(){return _ranges}function handleActiveCellChange(e,data){_options.selectActiveRow&&null!=data.row&&setSelectedRanges([new Slick.Range(data.row,0,data.row,_grid.getColumns().length-1)])}function selectAll(){_ranges=[new Slick.Range(0,0,_grid.getDataLength()-1,_grid.getColumns().length-1)],setSelectedRanges(_ranges)}function handleKeyDown(e){if(65===e.which&&(e.ctrlKey||e.metaKey))return selectAll(),e.preventDefault(),void e.stopImmediatePropagation();var activeRow=_grid.getActiveCell();if(activeRow&&e.shiftKey&&!e.ctrlKey&&!e.altKey&&!e.metaKey&&(38==e.which||40==e.which)){var selectedRows=getSelectedRows();selectedRows.sort(function(x,y){return x-y}),selectedRows.length||(selectedRows=[activeRow.row]);var active,top=selectedRows[0],bottom=selectedRows[selectedRows.length-1];active=40==e.which?activeRow.row<bottom||top==bottom?++bottom:++top:activeRow.row<bottom?--bottom:--top,active>=0&&active<_grid.getDataLength()&&(_grid.scrollRowIntoView(active),_ranges=rowsToRanges(getRowsRange(top,bottom)),setSelectedRanges(_ranges)),e.preventDefault(),e.stopPropagation()}}function handleClick(e){var cell=_grid.getCellFromEvent(e);if(!cell||!_grid.canCellBeActive(cell.row,cell.cell))return!1;if(_grid.getOptions().multiSelect&&1==_ranges.length&&0===_ranges[0].fromRow&&_ranges[0].toRow===_grid.getDataLength()-1)return _grid.setActiveCell(cell.row,cell.cell),_ranges=rowsToRanges([cell.row]),setSelectedRanges(_ranges),!0;if(!_grid.getOptions().multiSelect||!e.ctrlKey&&!e.shiftKey&&!e.metaKey)return!1;var selection=rangesToRows(_ranges),idx=$.inArray(cell.row,selection);if(idx===-1&&(e.ctrlKey||e.metaKey))selection.push(cell.row),_grid.setActiveCell(cell.row,cell.cell);else if(idx!==-1&&(e.ctrlKey||e.metaKey))selection=$.grep(selection,function(o,i){return o!==cell.row}),_grid.setActiveCell(cell.row,cell.cell);else if(selection.length&&e.shiftKey){var last=selection.pop(),from=Math.min(cell.row,last),to=Math.max(cell.row,last);selection=[];for(var i=from;i<=to;i++)i!==last&&selection.push(i);selection.push(last),_grid.setActiveCell(cell.row,cell.cell)}return _ranges=rowsToRanges(selection),setSelectedRanges(_ranges),!0}var _grid,_inHandler,_options,_ranges=[],_self=this,_handler=new Slick.EventHandler,_defaults={selectActiveRow:!0};$.extend(this,{getSelectedRows:getSelectedRows,setSelectedRows:setSelectedRows,getSelectedRanges:getSelectedRanges,setSelectedRanges:setSelectedRanges,init:init,destroy:destroy,selectAll:selectAll,onSelectedRangesChanged:new Slick.Event})}$.extend(!0,window,{Slick:{RowSelectionModel:RowSelectionModel}})}(jQuery),"undefined"==typeof tablelegs&&(tablelegs={}),tablelegs.Grid=function(options){function getItemColumnValue(item,column){return column.getter(item)}this.options=options;var slickGrid,_this=this;this.items=options.items,this.modelToView=null,this.viewOrder=null,this.rowClassProvider=function(){return""},this.filter=new tablelegs.CombinedGridFilter;var model={getLength:function(){return null!=_this.viewOrder?_this.viewOrder.length:_this.items.length},getItem:function(index){return _this.items[null!=_this.viewOrder?_this.viewOrder[index]:index]},getItemMetadata:function(viewIndex){var c=_this.rowClassProvider(viewIndex);if(null!=c)return{cssClasses:c}}};this.$el=options.$el;var gridOptions=$.extend({},{select:!0,multiColumnSort:!0,forceSyncScrolling:!0,multiSelect:options.multiSelect,enableTextSelectionOnCells:null==options.enableTextSelectionOnCells||options.enableTextSelectionOnCells,forceFitColumns:!0,dataItemColumnValueExtractor:getItemColumnValue,defaultFormatter:function(row,cell,value,columnDef,dataContext){if(_.isNumber(value))return Math.floor(value)===value?value:morpheus.Util.nf(value);if(morpheus.Util.isArray(value)){for(var s=[],i=0,length=value.length;i<length;i++){i>0&&s.push(", ");value[i];s.push(value[i])}return s.join("")}return value}},options.gridOptions||{});slickGrid=new Slick.Grid(options.$el,model,options.columns,gridOptions),this.slickGrid=slickGrid,gridOptions.select&&(slickGrid.setSelectionModel(new Slick.RowSelectionModel({selectActiveRow:!0,multiSelect:gridOptions.multiSelect})),slickGrid.getSelectionModel().onSelectedRangesChanged.subscribe(function(e){_this.trigger("selectionChanged",{selectedRows:slickGrid.getSelectedRows()})})),slickGrid.onSort.subscribe(function(e,args){_this.sortCols=args.sortCols,_this._updateMappings(),slickGrid.invalidate()}),slickGrid.onClick.subscribe(function(e){var cell=slickGrid.getCellFromEvent(e);cell&&_this.trigger("click",{row:cell.row,cell:cell.cell,target:e.target})}),options.$el.on("mouseover",".slick-row",function(e){var cell=slickGrid.getCellFromEvent(e);cell&&_this.trigger("mouseover",{row:cell.row,cell:cell.cell,target:e.target})}),options.$el.on("mouseout",".slick-row",function(e){var cell=slickGrid.getCellFromEvent(e);cell&&_this.trigger("mouseout",{row:cell.row,cell:cell.cell,target:e.target})}),options.$el.on("dblclick",function(e){var cell=slickGrid.getCellFromEvent(e);cell&&_this.trigger("dblclick",{row:cell.row,target:e.target})}),options.sort&&this.setSortColumns(options.sort),this.slickGrid.invalidate()},tablelegs.Grid.prototype={columnsAutosized:!1,setSortColumns:function(columns){var gridSortColumns=[],gridColumns=this.slickGrid.getColumns();this.sortCols=[];var _this=this;columns.forEach(function(c){for(var column=null,i=0;i<gridColumns.length;i++)if(gridColumns[i].name===c.name){column=gridColumns[i];break}null!=column&&gridSortColumns.push({columnId:column.id,sortAsc:c.ascending}),_this.sortCols.push({sortCol:c,sortAsc:c.ascending})}),this.slickGrid.setSortColumns(gridSortColumns),this._updateMappings(),this.slickGrid.invalidate()},setRowClassProvider:function(rowClassProvider){this.rowClassProvider=null==rowClassProvider?function(){return""}:rowClassProvider},setColumns:function(columns){this.slickGrid.setColumns(columns),this.columnsAutosized=!1,this.autosizeColumns(),this.slickGrid.invalidate()},getColumns:function(){return this.slickGrid.getColumns()},getSelectedRows:function(){return this.slickGrid.getSelectedRows()},getSelectedItems:function(){for(var rows=this.slickGrid.getSelectedRows(),selection=[],i=0,nrows=rows.length;i<nrows;i++)selection.push(this.items[this.convertViewIndexToModel(rows[i])]);return selection},getSelectedItem:function(){var rows=this.slickGrid.getSelectedRows();return 1===rows.length?this.items[this.convertViewIndexToModel(rows[0])]:null},setCellCssClass:function(rowIndices,columnIndices,cssClass,clear){var hash=clear?{}:this.slickGrid.getCellCssStyles("user");hash||(hash={});for(var columns=this.slickGrid.getColumns(),i=0;i<rowIndices.length;i++){var row=rowIndices[i];hash[row]||(hash[row]={});for(var j=0;j<columnIndices.length;j++)hash[row][columns[columnIndices[j]].id]=cssClass}this.slickGrid.setCellCssStyles("user",hash)},getItems:function(){for(var items=[],i=0,length=this.getFilteredItemCount();i<length;i++)items.push(this.items[this.convertViewIndexToModel(i)]);return items},getAllItemCount:function(){return this.items.length},getAllItems:function(){return this.items},getFilteredItemCount:function(){return this.viewOrder?this.viewOrder.length:this.items.length},redraw:function(){this.slickGrid.invalidate()},selectAll:function(){this.slickGrid.getSelectionModel().selectAll()},redrawRows:function(rows){this.slickGrid.invalidateRows(rows),this.slickGrid.render()},setItems:function(items){this.items=items,this.slickGrid.getSelectionModel()&&this.slickGrid.setSelectedRows([]),this.setFilter(this.filter),this.maybeAutoResizeColumns()},maybeAutoResizeColumns:function(){this.columnsAutosized||this.autosizeColumns()},convertModelIndexToView:function(modelIndex){if(null!==this.modelToView){var index=this.modelToView.get(modelIndex);return void 0!==index?index:-1}return modelIndex},convertViewIndexToModel:function(viewIndex){return null!=this.viewOrder?viewIndex<this.viewOrder.length&&viewIndex>=0?this.viewOrder[viewIndex]:-1:viewIndex},_updateMappings:function(){var selectedViewIndices=null!=this.slickGrid.getSelectionModel()?this.slickGrid.getSelectedRows():null,selectedModelIndices=[];if(selectedViewIndices)for(var i=0,length=selectedViewIndices.length;i<length;i++)selectedModelIndices.push(this.convertViewIndexToModel(selectedViewIndices[i]));if(this.viewOrder=null,null!=this.filter&&(this.filter.init(),!this.filter.isEmpty())){this.viewOrder=[];for(var i=0,length=this.items.length;i<length;i++)this.filter.accept(this.items[i])&&this.viewOrder.push(i)}var cols=this.sortCols;if(cols&&cols.length>0){if(null==this.viewOrder){this.viewOrder=[];for(var i=0,length=this.items.length;i<length;i++)this.viewOrder.push(i)}var ncols=cols.length,items=this.items;this.viewOrder.sort(function(index1,index2){for(var i=0;i<ncols;i++){var getter=cols[i].sortCol.sortGetter||cols[i].sortCol.getter,comparator=cols[i].sortAsc?tablelegs.ASCENDING_COMPARATOR:tablelegs.DESCENDING_COMPARATOR,value1=getter(items[index1]),value2=getter(items[index2]),result=comparator(value1,value2);if(0!==result)return result}return 0})}if(null!=this.viewOrder){this.modelToView=new morpheus.Map;for(var i=0,length=this.viewOrder.length;i<length;i++)this.modelToView.set(this.viewOrder[i],i)}else this.modelToView=null;if(null!=this.slickGrid.getSelectionModel()){for(var newSelectedViewIndices=[],i=0,length=selectedModelIndices.length;i<length;i++){var index=this.convertModelIndexToView(selectedModelIndices[i]);index!==-1&&newSelectedViewIndices.push(index)}this.slickGrid.setSelectedRows(newSelectedViewIndices)}},setSelectedRows:function(rows){this.slickGrid.setSelectedRows(rows)},setFilter:function(filter){this.filter=filter,this._updateMappings(),this.slickGrid.invalidate(),this.trigger("filter")},getFilter:function(){return this.filter},autosizeColumns:function(){var columns=this.slickGrid.getColumns(),items=this.getItems();if(items&&0!==items.length&&columns&&0!==columns.length){var gridWidth=this.options.$el.width()-30;if(!(gridWidth<=0)){this.columnsAutosized=!0;var div=document.createElement("div");document.body.appendChild(div);var $d=$(div);$d.css({position:"absolute",left:-1e3,top:-1e3});var $row=$('<div class="slick-table"><div class="ui-state-default slick-header-column slick-header-sortable ui-sortable-handle"></div><div class="ui-widget-content slick-row"><div class="slick-cell selected"></div></div></div>'),$cell=$row.find(".slick-cell"),$header=$row.find(".slick-header-column");$row.appendTo($d);for(var maxWidth=Math.min(parseInt(gridWidth/2),400),computeColumnWidth=function(column){var w=0;if(column.resizable)if(w=$header.html(column.name).outerWidth()+12,column.prototypeValue)$cell.html(column.prototypeValue),w=Math.max($cell.outerWidth(),w);else for(var i=0,nrows=Math.min(items.length,10);i<nrows;i++){var html=column.formatter(i,null,column.getter(items[i]),column,items[i]),$html=$(html);$html.find(".slick-cell-wrapper").attr("class",""),$cell.html($html),w=Math.max($cell.outerWidth(),w)}return column.maxWidth&&(w=Math.min(w,column.maxWidth)),column.minWidth&&(w=Math.max(w,column.minWidth)),w},totalWidth=0,i=0;i<columns.length;i++)columns[i].width=parseInt(Math.min(maxWidth,computeColumnWidth(columns[i]))),totalWidth+=columns[i].width;$d.remove(),this.slickGrid.resizeCanvas()}}}},morpheus.Util.extend(tablelegs.Grid,morpheus.Events),tablelegs.AutoTooltips2=function(options){function init(slickGrid){_grid=slickGrid,$(_grid.getCanvasNode()).on("mouseover",".slick-row",showToolTip)}function destroy(){$(_grid.getCanvasNode()).off("mouseover",showToolTip)}function showToolTip(e){var cell=_grid.getCellFromEvent(e);if(cell){var $node=$(_grid.getCellNode(cell.row,cell.cell)),text="",c=_grid.getColumns()[cell.cell],show=!1,$checkNode=$node.find(".slick-cell-wrapper");if(c.tooltip&&(c.alwaysShowTooltip||$checkNode[0].scrollWidth>$checkNode[0].offsetWidth)){var item=_grid.getDataItem(cell.row);text=c.tooltip(item,c.getter(item)),show=!0}$node.attr("title",text)}}var _grid;$.extend(this,{init:init,destroy:destroy})},tablelegs.CombinedGridFilter=function(){this.filters=[]},tablelegs.CombinedGridFilter.prototype={add:function(filter){this.filters.push(filter)},getFilters:function(){return this.filters},get:function(index){return this.filters[index]},set:function(index,f){this.filters[index]=f},init:function(){for(var i=0;i<this.filters.length;i++)this.filters[i].init();this.activeFilters=this.filters.filter(function(f){return!f.isEmpty()}),this.nActiveFilters=this.activeFilters.length},accept:function(item){for(var i=0;i<this.nActiveFilters;i++)if(!this.activeFilters[i].accept(item))return!1;return!0},isEmpty:function(){return 0===this.activeFilters.length}},tablelegs.ASCENDING_COMPARATOR=function(a,b){var aNaN=null==a||_.isNumber(a)&&isNaN(a),bNaN=null==b||_.isNumber(b)&&isNaN(b);return aNaN&&bNaN?0:aNaN?1:bNaN?-1:(a.toLowerCase&&(a=a.toLowerCase()),b.toLowerCase&&(b=b.toLowerCase()),a===b?0:a<b?-1:1)},tablelegs.DESCENDING_COMPARATOR=function(a,b){var aNaN=null==a||_.isNumber(a)&&isNaN(a),bNaN=null==b||_.isNumber(b)&&isNaN(b);return aNaN&&bNaN?0:aNaN?1:bNaN?-1:(a.toLowerCase&&(a=a.toLowerCase()),b.toLowerCase&&(b=b.toLowerCase()),a===b?0:a<b?1:-1)},tablelegs.Table=function(options){var _this=this;this.alwaysTrue=function(){return!0},options=tablelegs.Table.createOptions(options),this.options=options;var height=options.height,$gridDiv=$('<div class="slick-table'+(options.tableClass?" "+options.tableClass:"")+'" style="width:'+options.fixedWidth+";height:"+height+'"></div>');this.$gridDiv=$gridDiv;var $header=$('<div class="slick-table-header"><div data-name="top"></div><div style="display: inline-block;" data-name="left" class="pad-top-8"></div><div style="display: inline-block;" data-name="buttons" class="pad-top-8"></div><div data-name="right" class="pull-right pad-top-8"></div></div>');this.$header=$header,$header.appendTo(options.$el),$gridDiv.appendTo(options.$el);var columns=options.columns;this.columns=columns;var visibleColumns=columns.filter(function(c){return c.visible}),grid=new tablelegs.Grid({gridOptions:{select:options.select,rowHeight:options.rowHeight,autoEdit:!1,editable:!1,autoHeight:"auto"===options.height,enableTextSelectionOnCells:!1},$el:$gridDiv,items:options.items,columns:visibleColumns});options.autoTooltips&&grid.slickGrid.registerPlugin(new tablelegs.AutoTooltips2),options.select&&(this.copy=function(ev){var active=document.activeElement,tagName=active.tagName;if("INPUT"==tagName||"SELECT"==tagName||"TEXTAREA"==tagName)return!1;if($gridDiv[0].contains(active)){var text=_this.itemsToText(_this.getSelectedItems(),!1);ev.originalEvent.clipboardData.setData("text/plain",text),ev.preventDefault(),ev.stopImmediatePropagation()}},this.beforeCopy=function(e){var active=document.activeElement,tagName=active.tagName;return"INPUT"!=tagName&&"SELECT"!=tagName&&"TEXTAREA"!=tagName&&void($gridDiv[0].contains(active)&&e.preventDefault())},$(window).on("copy.tablelegs",this.copy).on("beforecopy.tablelegs",this.beforeCopy)),this.grid=grid,this.searchFunction=this.alwaysTrue;var searchFilter={isEmpty:function(){return _this.searchFunction===_this.alwaysTrue},init:function(){},accept:function(item){return _this.searchFunction(item)}};this.grid.getFilter().add(searchFilter);var $right=$header.find(".pull-right");if(options["export"]){var $export=$('<button name="export" type="button">Export</button>');$export.appendTo($header.find("[data-name=buttons]")),$export.on("click",function(e){e.preventDefault(),_this.exportTable()})}if(options.search){var tableSearch=new tablelegs.TableSearchUI({autocomplete:options.autocomplete,$el:$header.find("[data-name=top]"),$right:$right});tableSearch.setTable(this),this.tableSearch=tableSearch}if(options.columnPicker){var $btn=$('<div style="position:absolute;top:0;right:0;"><div class="dropdown dropdown-select"><button data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" type="button" class="btn btn-default btn-sm light-btn-xs"><i class="fa fa-cog"></button><ul style="max-height:300px;overflow-y:auto;" class="dropdown-menu dropdown-menu-right"></ul></div></div>');$btn.appendTo(this.$gridDiv),this.$columnSelect=$btn.find(".dropdown-menu");var sortedColumns=this.columns.slice().sort(function(a,b){return a=a.name.toLowerCase(),b=b.name.toLowerCase(),a===b?0:a<b?-1:1}),li=[];li.push('<li class="dropdown-header">Show/Hide Columns</li>'),sortedColumns.forEach(function(c){!c.hidden&&c.isHideable&&(li.push('<li><a data-value="'+c.id+'" data-checked="'+c.visible+'" href="#">'+c.name),c.visible?li.push(' <span class="fa fa-check check-mark"></span>'):li.push(" <span></span>"),li.push("</a></li>"))}),$(li.join("")).appendTo(this.$columnSelect),this.$columnSelect.on("click","a",function(e){e.preventDefault(),e.stopPropagation();var $a=$(this),checked=$a.data("checked");checked=!checked,$a.data("checked",checked),$a.parent().attr("class",checked?"selected":"");var $span=$a.find("span");$span.attr("class",checked?"fa fa-check check-mark":"");for(var $checked=_this.$columnSelect.find("a"),selectedColumnIds=[],i=0;i<$checked.length;i++)$($checked[i]).data("checked")&&selectedColumnIds.push($($checked[i]).data("value"));selectedColumnIds=sortedColumns.filter(function(c){return!c.isHideable}).map(function(c){return c.id}).concat(selectedColumnIds),_this.setVisibleColumnIds(selectedColumnIds)})}var lastWidth=-1,lastHeight=-1,resize=function(){if(_this.options.responsive&&options.$el.is(":visible")){var resizedWidth=!1,resizedHeight=!1;if(options.responsiveHeight){var tableHeight=options.$el[0].getBoundingClientRect().height;lastHeight!==tableHeight&&(lastHeight=tableHeight,$gridDiv.css("height",tableHeight+"px"),resizedHeight=!0)}var gridWidth=options.$el.width();if(gridWidth!==lastWidth&&gridWidth>0){lastWidth=gridWidth;var minWidth=Math.max(gridWidth,options.collapseBreakpoint);$gridDiv.css("width",minWidth+"px"),resizedWidth=!0}(resizedHeight||resizedWidth)&&(_this.grid.slickGrid.resizeCanvas(),_this.grid.slickGrid.invalidate()),resizedWidth&&_this.grid.maybeAutoResizeColumns()}};if(options.showHeader||$gridDiv.find(".slick-header").hide(),(options.responsive||options.responsiveHeight)&&($(window).on("resize orientationchange",resize),resize()),this.resize=resize,$gridDiv.on("remove",function(){$(window).off("resize orientationchange",resize).off("copy.tablelegs",_this.copy).off("beforecopy.tablelegs",_this.beforeCopy)}),options.columns.forEach(function(c){c.renderer&&c.renderer.init&&c.renderer.init({table:_this,column:c})}),visibleColumns.length>1&&null!=options.items&&options.items.length>0&&this.setItems(options.items),!$gridDiv.is(":visible")){for(var $parent=$gridDiv,observer=new MutationObserver(function(mutations){"none"!==window.getComputedStyle($parent[0]).display&&(observer.disconnect(),resize())});$parent.length>0&&"none"!==window.getComputedStyle($parent[0]).display;)$parent=$parent.parent();$parent.length>0&&observer.observe($parent[0],{attributes:!0,childList:!1,characterData:!1})}},tablelegs.Table.defaultRenderer=function(item,value){if(null==value)return"";if(_.isNumber(value))return Math.floor(value)===value?value:morpheus.Util.nf(value);if(morpheus.Util.isArray(value)){for(var s=[],i=0,length=value.length;i<length;i++){i>0&&s.push(", ");value[i];s.push(value[i])}return s.join("")}return""+value},tablelegs.Table.prototype={setVisibleColumnIds:function(ids){for(var oldColumnIdToIndex=new morpheus.Map,oldColumns=this.grid.getColumns(),i=0;i<oldColumns.length;i++)oldColumnIdToIndex.set(oldColumns[i].id,i);var idToColumn=new morpheus.Map;this.columns.forEach(function(c){idToColumn.set(c.id,c)});for(var visibleColumns=[],i=0;i<ids.length;i++){var id=ids[i],c=idToColumn.get(id);null!=c?visibleColumns.push(c):console.log(id+" not found.")}visibleColumns.sort(function(a,b){return a=oldColumnIdToIndex.get(a.id),void 0===a&&(a=Number.MAX_VALUE),b=oldColumnIdToIndex.get(b.id),void 0===b&&(b=Number.MAX_VALUE),a===b?0:a<b?-1:1}),this.columns.forEach(function(c){c.visible=!1}),visibleColumns.forEach(function(c){c.visible=!0}),this.grid.setColumns(visibleColumns),this.resize(),this.redraw()},removeColumns:function(columnIds){var _this=this;columnIds.forEach(function(id){var index=_.findIndex(_this.columns,function(column){return column.id===id});index!==-1&&_this.columns.splice(index,1)}),this.setVisibleColumnIds(this.columns.filter(function(c){return c.visible}).map(function(c){return c.id})),this._rebuildColumnSelector()},_rebuildColumnSelector:function(){if(this.$columnSelect){var $columnSelect=this.$columnSelect;$columnSelect.empty();var sortedColumns=this.columns.slice().sort(function(a,b){return a=a.name.toLowerCase(),b=b.name.toLowerCase(),a===b?0:a<b?-1:1}),li=[];li.push('<li class="dropdown-header">Show/Hide Columns</li>'),sortedColumns.forEach(function(c){!c.hidden&&c.isHideable&&(li.push('<li><a data-value="'+c.id+'" data-checked="'+c.visible+'" href="#">'+c.name),c.visible?li.push('<span class="fa fa-check check-mark"></span>'):li.push("<span></span>"),li.push("</a></li>"))}),$columnSelect.html($(li.join("")))}},addColumns:function(columns){this.columns=this.columns.concat(columns),this.setVisibleColumnIds(this.columns.filter(function(c){return c.visible}).map(function(c){return c.id})),this._rebuildColumnSelector()},exportTable:function(){var _this=this;if(!this.options.beforeExport||this.options.beforeExport()){var formBuilder=new morpheus.FormBuilder;formBuilder.append({name:"file_name",type:"text",value:this.options.exportFileName}),formBuilder.find("file_name").prop("autofocus",!0).focus(),morpheus.FormBuilder.showOkCancel({title:"Export",draggable:!0,content:formBuilder.$form,align:"right",okCallback:function(){var blob=new Blob([_this.toText()],{type:"text/plain;charset=utf-8"});saveAs(blob,formBuilder.getValue("file_name"),!0),_this.trigger("export",{table:this})}})}},itemsToText:function(items,header){var text=[],columns=this.columns.filter(function(c){return c.visible&&c["export"]});if(header){for(var j=0;j<columns.length;j++)j>0&&text.push("\t"),text.push(columns[j].name);text.push("\n")}for(var i=0;i<items.length;i++){for(var item=items[i],j=0;j<columns.length;j++){j>0&&text.push("\t");var value=columns[j].getter(item);text.push(morpheus.Util.toString(value))}text.push("\n")}return text.join("")},toText:function(){return this.itemsToText(this.options.getExportItems(this),!0)},getColumnCount:function(){return this.columns.filter(function(c){return c.visible}).length},setCellCssClass:function(rows,columns,cssClass,clear){this.grid.setCellCssClass(rows,columns,cssClass,clear)},setHeight:function(height){this.options.height=height,"auto"===height?(this.grid.slickGrid.getOptions().autoHeight=!0,this.grid.slickGrid.setOptions(this.grid.slickGrid.getOptions()),this.$gridDiv.css({height:"","margin-bottom":"11px"}),this.$gridDiv.find(".slick-viewport").css("height","")):this.$gridDiv.css({height:height,"margin-bottom":""}),this.grid.slickGrid.resizeCanvas(),this.grid.slickGrid.invalidate(),this.grid.slickGrid.render()},autocomplete:function(tokens,response){function formatResponse(){var matches=[],isShowAll="*"===token,replaceRegex=new RegExp("("+morpheus.Util.escapeRegex(token)+")","i");fieldNameToMatches.forEach(function(matchesSet,field){if(matchesSet.show||matchesSet.size()>0){var column=columnNameToColumn.get(field.toLowerCase()),quotedField=field;quotedField.indexOf(" ")!==-1&&(quotedField='"'+quotedField+'"'),showFieldName&&("string"===column.dataType||"[string]"===column.dataType?column.showAll&&isShowAll?matches.push({"class":"search-qualifier",value:quotedField+":",label:'<span class="search-qualifier-field">'+field+":</span>",show:!0}):matches.push({"class":"search-qualifier",value:quotedField+":",label:'<span class="search-qualifier-field">'+field+":</span>",show:!0}):matches.push({"class":"search-qualifier",value:quotedField+":",label:'<span class="search-qualifier-field">'+field+':</span><span class="search-qualifier-range">min..max</span>',show:!0}));var fieldMatches=[];matchesSet.forEach(function(val){var quotedValue=val;null!=quotedValue&&quotedValue.indexOf(" ")!==-1&&(quotedValue='"'+quotedValue+'"'),fieldMatches.push({_v:val,value:showFieldName?quotedField+":"+quotedValue:quotedValue,label:"<span>"+val.replace(replaceRegex,"<b>$1</b>")+"</span>"})}),fieldMatches.sort(function(m1,m2){var a=m1._v.toLowerCase(),b=m2._v.toLowerCase();return a===b?0:a<b?-1:1}),matches=matches.concat(fieldMatches)}}),response(matches)}var _this=this,token=null!=tokens&&tokens.length>0?tokens[tokens.selectionStartIndex]:"";token=$.trim(token);var columns=this.columns.filter(function(c){return c.searchable&&(c.visible||_this.options.searchAllColumns)}),showFieldName=columns.length>1,items=this.getAllItems();columns.forEach(function(c){if(null==c.dataType)for(var i=0,nitems=items.length;i<nitems;i++){var value=c.getter(items[i]);if(null!=value){if(morpheus.Util.isArray(value)&&0===value.length)continue;c.dataType=morpheus.Util.getDataType(value);break}}});var ncolumns=columns.length;if(""===token||token.length<2){var matches=[];if(ncolumns<=1)return response(matches);for(var i=0;i<ncolumns;i++){var c=columns[i],field=c.name,quotedField=field;quotedField.indexOf(" ")!==-1&&(quotedField='"'+quotedField+'"'),"string"===c.dataType||"[string]"===c.dataType?c.showAll?matches.push({"class":"search-qualifier",value:quotedField+":",showAll:quotedField+":*",label:'<span class="search-qualifier-field">'+field+':</span><span data-autocomplete="showAll" class="search-qualifier-show-all">Show all</span>',show:!0}):matches.push({"class":"search-qualifier",value:quotedField+":",label:'<span class="search-qualifier-field">'+field+":</span>",show:!0}):matches.push({"class":"search-qualifier",value:quotedField+":",label:'<span class="search-qualifier-field">'+field+':</span><span class="search-qualifier-range">min..max</span>',show:!0})}return matches.sort(function(m1,m2){var a=m1.value.toLowerCase(),b=m2.value.toLowerCase();return a===b?0:a<b?-1:1}),response(matches)}for(var field=null,semi=token.indexOf(":"),regex=new RegExp(morpheus.Util.escapeRegex(token),"i"),fieldSearch=!1,columnNameToColumn=new morpheus.Map,fieldNameToMatches=new morpheus.Map,i=0;i<columns.length;i++)columnNameToColumn.set(columns[i].name.toLowerCase(),columns[i]),fieldNameToMatches.set(columns[i].name,new morpheus.Set);if(semi>0){if(92!==token.charCodeAt(semi-1)){var possibleToken=$.trim(token.substring(semi+1)),possibleField=$.trim(token.substring(0,semi));possibleField.length>0&&'"'===possibleField[0]&&'"'===possibleField[possibleField.length-1]?possibleField=possibleField.substring(1,possibleField.length-1):possibleField.length>0&&'"'===possibleField[0]&&'"'===possibleToken[possibleToken.length-1]&&'"'!==possibleToken[0]&&(possibleField=possibleField.substring(1,possibleField.length),possibleToken='"'+possibleToken);var c=columnNameToColumn.get(possibleField.toLowerCase());void 0!==c&&(token=possibleToken,field=possibleField,fieldSearch=!0,columns=[c])}}else if(ncolumns>1)for(var j=0;j<ncolumns;j++){var field=columns[j].name;if(regex.test(field)){var matchesSet=fieldNameToMatches.get(field);matchesSet.show=!0}}for(var filteredColumns=[],i=0;i<columns.length;i++){var c=columns[i];"string"!==c.dataType&&"[string]"!==c.dataType||filteredColumns.push(c)}regex=new RegExp(morpheus.Util.escapeRegex(token),"i"),columns=filteredColumns,ncolumns=columns.length;for(var nmatches=0,maxSize=1===ncolumns&&"*"===token?Number.MAX_VALUE:10,i=0,nitems=items.length;i<nitems;i++)for(var item=items[i],j=0;j<ncolumns;j++){var column=columns[j],field=column.name,matchesSet=fieldNameToMatches.get(field),value=column.getter(item);if("[string]"===column.dataType)for(var nvalues=null==value?0:value.length,k=0;k<nvalues;k++){var val=value[k];if(regex.test(val)&&!matchesSet.has(val)&&(matchesSet.add(val),nmatches++,nmatches===maxSize))return formatResponse()}else if(null!=value&&regex.test(value)&&!matchesSet.has(value)&&(matchesSet.add(value),nmatches++,nmatches===maxSize))return formatResponse()}return formatResponse()},searchWithPredicates:function(predicates){var _this=this;if(null==predicates||0===predicates.length)return this.searchFunction=this.alwaysTrue,void this.grid.setFilter(this.grid.getFilter());for(var columns=this.columns.filter(function(c){return c.searchable&&(c.visible||_this.options.searchAllColumns)}),columnNameToColumn=new morpheus.Map,columnNames=columns.map(function(c){return c.name}),i=0;i<columnNames.length;i++)columnNameToColumn.set(columnNames[i].toLowerCase(),columns[i]);for(var filteredPredicates=[],npredicates=predicates.length,i=0;i<npredicates;i++){var predicate=predicates[i],filterColumnName=predicate.getField();if(null!=filterColumnName){var column=columnNameToColumn.get(filterColumnName.toLowerCase());column&&(predicate.column=column,filteredPredicates.push(predicate))}else filteredPredicates.push(predicate)}predicates=filteredPredicates,npredicates=predicates.length;var f=function(item){for(var p=0;p<npredicates;p++){var searchColumns,predicate=predicates[p];searchColumns=predicate.column?[predicate.column]:columns;for(var j=0,ncolumns=searchColumns.length;j<ncolumns;j++){var value=searchColumns[j].getter(item);if(morpheus.Util.isArray(value)){for(var nvalues=value.length,i=0;i<nvalues;i++)if(predicate.accept(value[i]))return!0}else{var predicate=predicates[p];if(predicate.accept(value))return!0}}}return!1};this.searchFunction=f,this.grid.setFilter(this.grid.getFilter())},setSortColumns:function(columns){var sort=[],allColumn=this.columns;columns.forEach(function(c){for(var column=null,i=0;i<allColumn.length;i++)if(allColumn[i].name===c.name){column=allColumn[i];break}null!=column&&(column.ascending=c.ascending,sort.push(column))}),this.grid.setSortColumns(sort),this.redraw()},search:function(text){var _this=this;if(""===text)this.searchFunction=this.alwaysTrue,this.grid.setFilter(this.grid.getFilter());else{var tokens=morpheus.Util.getAutocompleteTokens(text),columns=this.columns.filter(function(c){return c.searchable&&(c.visible||_this.options.searchAllColumns)}),columnNames=columns.map(function(c){return c.name}),predicates=morpheus.Util.createSearchPredicates({tokens:tokens,fields:columnNames,caseSensitive:!1});this.searchWithPredicates(predicates)}},getSelectedRows:function(){return this.grid.getSelectedRows()},getSelectedItems:function(){return this.grid.getSelectedItems()},selectAll:function(){this.grid.selectAll()},getSelectedItem:function(){return this.grid.getSelectedItem()},setSelectedRows:function(rows){this.grid.setSelectedRows(rows)},getItems:function(){return this.grid.getItems()},getItem:function(index){return this.grid.getItems()[index]},getAllItems:function(){return this.grid.getAllItems()},getAllItemCount:function(){return this.grid.getAllItemCount()},getFilteredItemCount:function(){return this.grid.getFilteredItemCount()},setFilter:function(f){
this.grid.setFilter(f)},refilter:function(){this.grid.setFilter(this.grid.getFilter())},getFilter:function(){return this.grid.getFilter()},setItems:function(items){this.grid.setItems(items),this.grid.redraw()},redraw:function(){this.grid.redraw()},setRowClassProvider:function(rowClassProvider){this.grid.setRowClassProvider(rowClassProvider)},on:function(evtStr,handler){return this.grid.on(evtStr,handler),this},off:function(evtStr,handler){return this.grid.off(evtStr,handler),this},trigger:function(evtStr){this.grid.trigger(evtStr)}},tablelegs.Table.showAllValues=function(table,column,$el){for(var set=new morpheus.Set,dataType=null,items=table.getItems(),i=0,nitems=items.length;i<nitems;i++){var value=column.getter(items[i]);if(null!=value){dataType=morpheus.Util.getDataType(value);break}}if(null!=dataType)if("[string]"===dataType||"[number]"===dataType)for(var i=0,nitems=items.length;i<nitems;i++){var value=column.getter(items[i]);if(null!=value)for(var j=0;j<value.length;j++)set.add(value[j])}else for(var i=0,nitems=items.length;i<nitems;i++){var value=column.getter(items[i]);set.add(value)}var array=set.values();array.sort(morpheus.SortKey.ASCENDING_COMPARATOR);var $div=$("<div></div>");new tablelegs.Table({$el:$div,items:array,responsive:!1,select:!1,fixedWidth:"550px",showHeader:!1,columns:[{getter:function(item){return item}}]}),morpheus.FormBuilder.showInModal({title:column.name,html:$div})},tablelegs.Table.createOptions=function(options){options=$.extend(!0,{},{items:[],height:"564px","export":!1,exportFileName:"export.txt",autoTooltips:!0,collapseBreakpoint:330,showHeader:!0,select:!0,responsive:!0,autocomplete:!0,fixedWidth:"320px",columnPicker:!0,getExportItems:function(table){return table.getItems()},searchAllColumns:!0},options),options.columns||(options.columns=[{name:""}]);var columns=[];return options.columns.forEach(function(c,i){var column=tablelegs.Table.createColumn(c,i);columns.push(column)}),options.columns=columns,null==options.tableClass&&(1===options.columns.length?options.tableClass="slick-table-compact":options.tableClass="slick-bordered-table"),options.rowHeight||(options.rowHeight=22),options},tablelegs.Table.createColumn=function(c,id){var column=$.extend(!0,{},{id:id,tooltip:function(dataContext,value){return tablelegs.Table.defaultRenderer(dataContext,value)},formatter:function(row,cell,value,columnDef,dataContext){var html=[];return html.push('<div class="slick-table-wrapper"><div class="slick-cell-wrapper">'),html.push(column.renderer(dataContext,value)),html.push("</div></div>"),html.join("")},width:void 0,minWidth:void 0,maxWidth:void 0,"export":!0,sortable:!0,searchable:!0,showAll:!1,name:c.name,isHideable:!0,renderer:tablelegs.Table.defaultRenderer},c);return void 0===column.visible&&(column.visible=!0),column.getter||(column.getter=null==column.field?function(item){return item}:function(item){return item[c.field]}),column},tablelegs.TableSearchUI=function(options){var _this=this,$search=$('<input name="searchInput" data-type="search" type="text" class="form-control input-sm search-input" placeholder="Search" autocomplete="off">');$search.appendTo(options.$el),this.$search=$search,this.$searchResults=$('<span data-name="rowcount" class="pad-right-8 pad-top-2 tableview-rowcount" data-type="search"></span>'),this.$showAll=$('<button data-name="showAll" data-type="search" class="pad-left-8 btn btn-primary btn-sm">Show All</button>'),this.$searchResults.appendTo(options.$right),options.showAll&&this.$showAll.appendTo(options.$right),this.$showAll.on("click",function(e){e.preventDefault(),$search.val(""),_this.table.search(""),_this.table.trigger("showAll",{table:_this.table})}),$search.on("keyup",_.debounce(function(){_this.table.search($.trim($(this).val()))},100)),options.autocomplete&&morpheus.Util.autosuggest({$el:$search,minLength:0,suggestWhenEmpty:options.suggestWhenEmpty,filter:function(tokens,response){_this.table.autocomplete(tokens,response)},select:function(){_this.table.search($.trim($search.val()))}})},tablelegs.TableSearchUI.prototype={updateSearchLabel:function(){var text="Viewing: "+morpheus.Util.intFormat(this.table.getFilteredItemCount())+" / "+morpheus.Util.intFormat(this.table.getAllItemCount());this.$searchResults.html(text)},setTable:function(table){this.table=table;var _this=this;table.on("filter",function(){_this.updateSearchLabel()})}},tablelegs.Table.createCheckBoxColumn=function(columnOptions){function updateCheckBox(){if(0===set.size())$cb.attr("class","fa fa-square-o");else{for(var items=table.getItems(),count=0,found=!1,notFound=!1,i=0;i<items.length;i++)if(set.has(column.getter(items[i]))){if(count++,found=!0,notFound)break}else if(notFound=!0,found)break;0===count?$cb.attr("class","fa fa-square-o"):count===items.length?$cb.attr("class","fa fa-check-square-o"):$cb.attr("class","fa fa-minus-square-o")}$exportLink&&(0===set.size()?$exportLink.addClass("disabled"):$exportLink.removeClass("disabled"))}function updateItemCount(){$selectedCount.html("("+morpheus.Util.intFormat(set.size())+")")}function toggleItem(item){var value=column.getter(item);set.has(value)?set.remove(value):set.add(value),table.trigger("checkBoxSelectionChanged",{source:table,set:set,column:column})}var set=new morpheus.Set,renderer=function(item,value){return'<span><input data-tablelegs-toggle="true" type="checkbox" '+(set.has(value)?" checked":"")+"/></span>"};columnOptions.renderer&&(renderer=columnOptions.renderer);var table,column,header=[];header.push('<div data-name="select" style="display:inline-block;" class="dropdown">'),header.push('<button class="btn dropdown-toggle row-selector-btn" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">'),header.push('<i data-name="checkbox" class="fa fa-square-o checkbox-dropdown" aria-hidden="true"></i>'),header.push('  <span data-name="count"></span> <span class="caret"></span>'),header.push("</button>"),header.push('<ul class="dropdown-menu">'),header.push('<li><a data-name="all" href="#">Select All</a></li>'),header.push('<li><a data-name="none" href="#">Select None</a></li>'),header.push('<li><a data-name="invert" href="#">Invert Selection</a></li>'),header.push("</ul>"),header.push("</div>");var $exportLink,$header=$(header.join("")),$selectedCount=$header.find("[data-name=count]"),$cb=$header.find("[data-name=checkbox]");$cb.on("click",function(e){if($cb.hasClass("fa-square-o"))for(var items=table.getItems(),i=0;i<items.length;i++)set.add(column.getter(items[i]));else for(var items=table.getItems(),i=0;i<items.length;i++)set.remove(column.getter(items[i]));table.trigger("checkBoxSelectionChanged",{source:table,set:set,column:column}),e.preventDefault(),e.stopPropagation()}),$header.on("click","a",function(e){var found=!1;if("none"===$(this).data("name"))set.clear(),found=!0;else if("all"===$(this).data("name")){for(var items=table.getItems(),i=0;i<items.length;i++)set.add(column.getter(items[i]));found=!0}else if("invert"===$(this).data("name")){for(var items=table.getItems(),i=0;i<items.length;i++)set.has(column.getter(items[i]))?set.remove(column.getter(items[i])):set.add(column.getter(items[i]));found=!0}found&&(table.trigger("checkBoxSelectionChanged",{source:table,set:set,column:column}),e.preventDefault())}),renderer.init=function(options){if(table=options.table,column=options.column,table.options.getExportItems=function(t){return table.getAllItems().filter(function(item){return set.has(column.getter(item))})},column.exportLink){var $export=$('<li role="separator" class="divider"></li><li data-name="exportLi" class="disabled"><a data-name="export" href="#">Export</a></li>');$export.appendTo($header.find("ul")),$exportLink=$header.find("[data-name=exportLi]"),$header.find("[data-name=export]").on("click",function(e){e.preventDefault(),table.exportTable()})}$header.prependTo(table.$header.find("[data-name=left]")),table.on("filter",updateCheckBox),table.$gridDiv.on("keyup",function(e){if(13===e.which){var item=table.getSelectedItem();null!=item&&toggleItem(item)}}),table.$gridDiv.on("click","input[data-tablelegs-toggle=true]",function(e){var cell=table.grid.slickGrid.getCellFromEvent(e);if(cell){var item=table.getItems()[cell.row];toggleItem(item)}}),updateItemCount(),table.on("checkBoxSelectionChanged",function(){updateCheckBox(),updateItemCount(),table.redraw()})};var c=$.extend(!0,{},{set:set,$header:$header,cssClass:"table-legs-align-center",headerCssClass:"text-center",getSelection:function(){return set},getter:function(item){return item[this.field]},name:'<i style="font-size:13px;" class="fa fa-check" aria-hidden="true"></i>',renderer:renderer,width:32,maxWidth:32,minWidth:32,resizable:!1,searchable:!1,hidden:!1,isHideable:!1,visible:!0,"export":!1,exportLink:!0},columnOptions);return c.sortGetter||(c.sortGetter=function(item){return!set.has(c.getter(item))}),c};