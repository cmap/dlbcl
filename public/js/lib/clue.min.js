"undefined"==typeof clue&&(clue={}),"undefined"!=typeof module&&module.exports&&(module.exports=clue),clue.USER_KEY=null,clue.usingTempKey=!1,clue.CORE_CELL_LINES=["A375","A549","HA1E","HCC515","HEPG2","HT29","MCF7","PC3","VCAP"],clue.PROTEOMICS_CELL_LINES=["A375","A549","MCF7","NPC","PC3","YAPC"],clue.CORE_CELL_LINES_LINEAGE={A375:"SKIN",A549:"LUNG",HA1E:"KIDNEY",HCC515:"LUNG",HEPG2:"LIVER",HT29:"LARGE_INTESTINE",MCF7:"BREAST",NPC:"CNS",PC3:"PROSTATE",VCAP:"PROSTATE",YAPC:"PANCREAS"},clue.CORE_CELL_LINES_CCLE=["A375_SKIN","A549_LUNG","HA1E_KIDNEY","HCC515_LUNG","HEPG2_LIVER","HT29_LARGE_INTESTINE","MCF7_BREAST","PC3_PROSTATE","VCAP_PROSTATE"],$.ajaxPrefilter(function(options,originalOptions,jqXHR){null!=clue.USER_KEY&&0===options.url.indexOf(clue.API_URL)&&jqXHR.setRequestHeader("user_key",clue.USER_KEY)}),clue.analytics=function(){var i,s,o,r,a,m;"clue.io"===window.location.hostname&&("undefined"==typeof ga&&(i=window,s=document,o="script",r="ga",i.GoogleAnalyticsObject=r,i.ga=i.ga||function(){(i.ga.q=i.ga.q||[]).push(arguments)},i.ga.l=1*new Date,a=s.createElement(o),m=s.getElementsByTagName(o)[0],a.async=1,a.src="//www.google-analytics.com/analytics.js",m.parentNode.insertBefore(a,m)),ga("create","UA-62656334-1","auto","clue"),null!=clue.getUserName()&&ga("clue.set","clue_user",clue.getUserName()),ga("clue.send","pageview"))},clue.cachedFetch=function(url,options,callback){try{var expiry=300;"number"==typeof options?(expiry=options,options=void 0):"object"==typeof options&&(expiry=options.seconds||expiry);var cacheKey=clue.hashstr(url+clue.USER_KEY);options.ignoreApiKey&&(cacheKey=clue.hashstr(url));var cached=localStorage.getItem(cacheKey),whenCached=localStorage.getItem(cacheKey+":ts");if(null!==cached&&null!==whenCached){if((Date.now()-whenCached)/1e3<expiry)return callback(null,JSON.parse(cached));localStorage.removeItem(cacheKey),localStorage.removeItem(cacheKey+":ts")}}catch(ex){console.log(ex)}var myInit={method:"GET",headers:new Headers({user_key:clue.USER_KEY})};options.ajax?$.ajax({url:url,type:"GET",cache:!0}).done(function(result){return localStorage.setItem(cacheKey,JSON.stringify(result)),localStorage.setItem(cacheKey+":ts",Date.now()),callback(null,result)}).fail(function(err){return callback(err)}):fetch(url,myInit).then(function(response){return response.json().then(function(data){return response.ok?data:Promise.reject({status:response.status,data:data})})}).then(function(result){return localStorage.setItem(cacheKey,JSON.stringify(result)),localStorage.setItem(cacheKey+":ts",Date.now()),callback(null,result)}).catch(function(error){return console.log("error:",error),callback(error,null)})},clue.cachedFetchSession=function(url,options,callback){try{var expiry=300;"number"==typeof options?(expiry=options,options=void 0):"object"==typeof options&&(expiry=options.seconds||expiry);var cacheKey=clue.hashstr(url+clue.USER_KEY);options.ignoreApiKey&&(cacheKey=clue.hashstr(url));var cached=sessionStorage.getItem(cacheKey),whenCached=sessionStorage.getItem(cacheKey+":ts");if(null!==cached&&null!==whenCached){if((Date.now()-whenCached)/1e3<expiry)return callback(null,JSON.parse(cached));sessionStorage.removeItem(cacheKey),sessionStorage.removeItem(cacheKey+":ts")}}catch(ex){console.log(ex)}var myInit={method:"GET",headers:new Headers({user_key:clue.USER_KEY})};options.ajax?$.ajax({url:url,type:"GET",cache:!0}).done(function(result){return sessionStorage.setItem(cacheKey,JSON.stringify(result)),sessionStorage.setItem(cacheKey+":ts",Date.now()),callback(null,result)}).fail(function(err){return callback(err)}):fetch(url,myInit).then(function(response){return response.json().then(function(data){return response.ok?data:Promise.reject({status:response.status,data:data})})}).then(function(result){return sessionStorage.setItem(cacheKey,JSON.stringify(result)),sessionStorage.setItem(cacheKey+":ts",Date.now()),callback(null,result)}).catch(function(error){return console.log("error:",error),callback(error,null)})},clue.hashstr=function(s){var hash=0;if(0===s.length)return hash;for(var i=0;i<s.length;i++){hash=(hash<<5)-hash+s.charCodeAt(i),hash&=hash}return hash},clue.getVersionFromUrl=function(url){var result=null;url&&url.substr(1).split("&").forEach(function(part){var item=part.split("=");"version"===item[0]&&(result=decodeURIComponent(item[1]))});return result},clue.parseApacheListing=function(url){var d=$.Deferred();return $.ajax({url:url}).done(function(html){for(var a=$(html).find("td > a"),files=[],i=1;i<a.length;i++){var text=$(a[i]).text();files.push(text)}files.sort(),d.resolve(files.map(function(file){return url+file}))}).fail(function(err){d.reject(err)}),d},clue.getUserName=function(){return Cookies.get("user_id")},clue.showLoginModal=function(){$loginModal.modal("show")},clue.hideAccountDropDown=function(){$("#header-drop-down").hide()},clue.getUserInfo=function(){var userInfo;return Cookies.get("user_info")&&(userInfo=JSON.parse(Cookies.get("user_info"))),userInfo};var config=Cookies.get("clue_config")||{};if(_.isEmpty(config))console.log("Empty clue config object");else{var co=JSON.parse(config);Object.freeze(co),clue.ENV=JSON.parse(config).env,clue.API_URL=JSON.parse(config).url,clue.whitelist_key=JSON.parse(config).whitelist_key}clue.isDomainOnWhitelist=function(email){return $.ajax({url:clue.API_URL+"/api/whitelists/"+clue.whitelist_key+"/domain/"+email+"/exists",type:"GET"})},clue.isDomainOnBlacklist=function(email){return $.ajax({url:clue.API_URL+"/api/blacklists/"+clue.whitelist_key+"/domain/"+email+"/exists",type:"GET"})},clue.isCMapCore=function(callback){var url=clue.API_URL+"/api/clue-privileges/isCore";clue.cachedFetch(url,{seconds:1800,ajax:!0},callback)},clue.isAdmin=function(callback){var url=clue.API_URL+"/api/clue-privileges/isAdmin";clue.cachedFetch(url,{seconds:1800,ajax:!0},callback)},clue.getSettings=function(callback){try{var cacheKey=clue.hashstr("/settings"+clue.USER_KEY);localStorage.removeItem(cacheKey),localStorage.removeItem(cacheKey+":ts")}catch(ee){}clue.cachedFetchSession("/settings",{seconds:1800,ajax:!0},callback)},clue.getAllEvents=function(callback){return $.ajax({url:"/allEvents",type:"GET",cache:!0})},clue.getRoles=function(callback){clue.cachedFetch(clue.API_URL+"/api/roles",{seconds:86400},callback)},clue.getServerInfo=function(callback){clue.cachedFetch("/server_info",{ignoreApiKey:!0,seconds:604800},callback)},clue.getApiRepurposingDefinitions=function(callback){var url=clue.API_URL+"/public/repurposing-definition";return $.ajax({url:url,type:"GET",cache:!0})},clue.getApiPublicDefinitions=function(callback){var url=clue.API_URL+"/public/definitions";return $.ajax({url:url,type:"GET",cache:!0})},clue.getConnectopediaGlossary=function(callback){var url=clue.API_URL+"/api/glossary/distinct?field=index";clue.cachedFetch(url,{ignoreApiKey:!0,seconds:86400},callback)},clue.getConnectopediaTags=function(callback){var url="https://s3.amazonaws.com/data.clue.io/connectopedia/"+clue.ENV+"/tags.json";clue.cachedFetch(url,{ignoreApiKey:!0,seconds:86400},callback)},clue.getTranscriptionalImpactForAllTouchstonePerts=function(callback){var url=clue.API_URL+'/api/perts?filter={"include":{"pcls":true},"where": {"pert_icollection" : "TS"},"fields" : ["tas","pert_type","pert_id","pert_iname"],"order":"tas DESC"}';return $.ajax({url:url,type:"GET",cache:!0})},clue.getGitInfo=function(callback){clue.cachedFetch("/build-info",{ignoreApiKey:!0,seconds:604800},callback)},clue.getApps=function(callback){clue.cachedFetch(clue.API_URL+"/api/app_list/getApps?server_env="+clue.ENV,{seconds:600},callback)},clue.nominate=function(callback){var url=clue.API_URL+"/api/nominate";return $.ajax({url:url,type:"GET",cache:!0})},clue.getAcademicTraining=function(callback){var url=clue.API_URL+"/api/academic_training";return $.ajax({url:url,type:"GET",cache:!0})},clue.getResearchRoles=function(callback){var url=clue.API_URL+"/api/research_roles";return $.ajax({url:url,type:"GET",cache:!0})},clue.autoCompleteInstituteUrl=function(callback){return clue.API_URL+"/api/institutions/autocomplete"},clue.touchStoneVersion=function(callback){clue.cachedFetch(clue.API_URL+"/api/touchstone-version",{ignoreApiKey:!0,seconds:86400},callback)},clue.nominatePerts=function(type,name){return $.ajax({url:clue.API_URL+"/api/nominate_entity?type="+type+"&name="+name,type:"GET"})},clue.autocomplete=function(options){morpheus.Util.autocomplete(options.$el,function(q,cb){for(var matches=[],regex=new RegExp("^"+q,"i"),max=options.max||3,values={},count=0,fieldNames=options.fieldNames,nfields=fieldNames.length,i=0,nitems=options.nitems;i<nitems&&count<max;i++){options.next();for(var j=0;j<nfields;j++){var str=options.getValue(fieldNames[j]);if(!values[str]&&regex.test(str)&&(values[str]=!0,++count===max))break}}for(var val in values)matches.push({value:val});cb(matches)},null,!1)},clue.search=function(text,options){if(""===(text=$.trim(text)))return null;var tokens=morpheus.Util.getAutocompleteTokens(text);if(0==tokens.length)return null;for(var fieldNames=options.fieldNames,predicates=morpheus.Util.createSearchPredicates({tokens:tokens,fields:fieldNames}),indices=[],npredicates=predicates.length,nfields=model.getMetadataCount(),i=0,nitems=options.nitems;i<nitems;i++){var matches=!1;options.next();for(var p=0;p<npredicates&&!matches;p++){var predicate=predicates[p],filterColumnName=predicate.getField();if(null!=filterColumnName){if(null!=(value=options.getValue(filterColumnName))&&predicate.accept(value)){matches=!0;break}}else for(var j=0;j<nfields;j++){var value;if(null!=(value=options.getValue(fieldNames[j]))&&predicate.accept(value)){matches=!0;break}}}matches&&indices.push(i)}return indices},clue.getCell=function(cell_id){return $.ajax({url:clue.API_URL+'/api/cells?filter={"where":{"cell_id":"'+encodeURIComponent(cell_id)+'"}}',type:"GET"})},clue.getPertInfo=function(pert_id){return $.ajax({url:clue.API_URL+'/api/perts?filter={"include":{"pcls":true},"where":{"pert_id":"'+encodeURIComponent(pert_id)+'"}}',type:"GET"})},clue.getGeneBySymbol=function(gene_symbol){return $.ajax({url:clue.API_URL+'/api/genes/findOne?filter={"where":{"gene_symbol":"'+encodeURIComponent(gene_symbol)+'"}}',type:"GET"})},clue.getPert=function(pert_iname){return $.ajax({url:clue.API_URL+"/api/pert-card/"+pert_iname,type:"GET"})},clue.getMissingCities=function(){return $.ajax({url:clue.API_URL+'/api/institutions?filter={"fields": ["id","institute", "country"], "where": {"city": "-666"}}',type:"GET"})},clue.userExists=function(email){return $.ajax({url:clue.API_URL+'/api/admin/users/exists?filter={"where":{"email":"'+encodeURIComponent(email)+'"}}',type:"GET"})},clue.guessInstitutionFromEmail=function(email){return $.ajax({url:clue.API_URL+"/api/institutions/domain/"+encodeURIComponent(email),type:"GET"})},clue.getTouchStone=function(){return $.ajax({url:clue.API_URL+"/touchstone",type:"GET"})},clue.getDosePoints=function(pert_iname){return $.ajax({url:clue.API_URL+"/api/sigs/doseByCoreCellLines/"+pert_iname,type:"GET"})},clue.searchPerts=function(search){return $.ajax({url:clue.API_URL+"/api/search/perts/"+search,type:"GET"})},clue.getHistory=function(){return $.ajax({url:clue.API_URL+'/api/jobs?filter={"where":{"user_id":"'+clue.getUserName()+'","status":{"inq":["pending","processing","submitted","completed"]}},"limit":10,"order":"created DESC"}',type:"GET"})},clue.autoCompleteInstitute=function(inst){return $.ajax({url:clue.autoCompleteInstituteUrl()+"?q="+inst,type:"GET"})},clue.loadScriptsWhenReady=function(scripts){$(document).one("clueReady",function(){for(var i=0;i<scripts.length;i++){var script=document.createElement("script");script.setAttribute("type","text/javascript"),script.setAttribute("src",scripts[i]),document.head.appendChild(script)}})},clue.setup=function(callback){clue.getUserKey(function(){callback&&callback();var result=clue.getApps();clue.nav(result.cards)},function(){clue.footer()})},clue.getTempApiKey=function(){return clue.usingTempKey=!0,$.ajax({url:clue.API_URL+"/temp_api_key",type:"GET"})},clue.getUserKey=function(callback,errorCallback){null!=clue.USER_KEY?callback(clue.USER_KEY):(clue.usingTempKey=!1,$.ajax({url:"/api_config",cache:!0,success:function(config){null!=config.api_key&&(clue.USER_KEY=config.api_key),callback(clue.USER_KEY),$(document).trigger("clueReady")},error:function(){errorCallback&&errorCallback()}}))},clue.fixUrl=function(url){return 0!==url.indexOf("data.clue.io")&&0!==url.indexOf("macchiato.clue.io")||(url="https://s3.amazonaws.com/"+url),url},clue.BASE_GUTC_DIGESTS_URL="//s3.amazonaws.com/macchiato.clue.io/builds/touchstone/v1.1/arfs/",clue.gutcTopResults=function(options){var deferred=$.Deferred(),d=morpheus.DatasetUtil.read(clue.BASE_GUTC_DIGESTS_URL+options.id+"/pert_id_summary.gct");return d.then(function(dataset){for(var array=[],i=0,nrows=dataset.getRowCount();i<nrows;i++)array.push({index:i,value:dataset.getValue(i,0)});array.sort(function(a,b){return a.value<b.value?1:a.value===b.value?0:-1});for(var idVector=dataset.getRowMetadata().get(0),results=[],n=(i=0,Math.min(array.length,options.top));i<n;i++){var index=array[i];results.push({id:idVector.getValue(index.index),score:dataset.getValue(index.index,0),rank:i+1})}i=0;var j=array.length-1;for(n=Math.min(options.bottom,array.length);i<n;i++,j--){index=array[j];results.push({id:idVector.getValue(index.index),score:dataset.getValue(index.index,0),rank:8796-i})}var filter={where:{pert_id:{inq:results.map(function(r){return r.id})}},fields:{description:!0,pert_id:!0,pert_iname:!0,pert_type:!0}};$.ajax(clue.API_URL+"/api/perts?filter="+JSON.stringify(filter)).fail(function(err){deferred.reject(err)}).done(function(items){for(var idToItem={},i=0,nitems=results.length;i<nitems;i++)idToItem[results[i].id]=results[i];for(i=0,nitems=items.length;i<nitems;i++){var item=items[i],result=idToItem[item.pert_id];void 0!==result&&(result.description=item.description,result.pert_iname=item.pert_iname,result.pert_type=item.pert_type)}deferred.resolve(results)})}),d.catch(function(err){deferred.reject(err)}),deferred},clue.getGutcResult=function(gutcOptions){var gutcUrl=gutcOptions.url;"/"!==gutcUrl[gutcUrl.length-1]&&(gutcUrl+="/");var d=$.Deferred();function unsignedResults(){var options={};gutcOptions.gutcSummary&&(options.pert_id_summary=gutcUrl+"pert_id_summary.gct"),gutcOptions.gutcCell&&(options.pert_id_cell=gutcUrl+"pert_id_cell.gct"),gutcOptions.pclCell&&(options.pcl_cell=gutcUrl+"pcl_cell.gct"),gutcOptions.pclSummary&&(options.pcl_summary=gutcUrl+"pcl_summary.gct"),gutcOptions.overrideColumns&&(options.overrideColumns=gutcOptions.overrideColumns),gutcUrl.lastIndexOf("UPTAG/")===gutcUrl.length-6&&(options.config=gutcUrl.substring(0,gutcUrl.length-6)+"config.yaml");var gutcPromise=clue.getGutcResultByUrl(options);gutcPromise.done(function(result){d.resolve(result)}),gutcPromise.fail(function(result){d.reject(result)})}if(0===gutcUrl.indexOf("https://s3.amazonaws.com/data.clue.io/api/")){var remainder=gutcUrl.substring("https://s3.amazonaws.com/data.clue.io/api/".length),resultsIndex=remainder.indexOf("/results");if(-1!==resultsIndex){var email=remainder.substring(0,resultsIndex);gutcUrl="https://s3.amazonaws.com/data.clue.io/api/"+encodeURIComponent(email)+remainder.substring(resultsIndex)}unsignedResults()}else{var signedPromise=clue.getSignedFolder(gutcUrl);signedPromise.done(function(nameToUrl){var options={};gutcOptions.gutcSummary&&(options.pert_id_summary=nameToUrl["pert_id_summary.gct"],null==options.pert_id_summary&&(options.pert_id_summary=nameToUrl["ps_pert_summary.gct"])),gutcOptions.gutcCell&&(options.pert_id_cell=nameToUrl["pert_id_cell.gct"]),gutcOptions.pclCell&&(options.pcl_cell=nameToUrl["pcl_cell.gct"]),nameToUrl["query_info.txt"]&&(options.columnInfo=nameToUrl["query_info.txt"]),nameToUrl["sig.gct"]&&(options.sig_gct=nameToUrl["sig.gct"]),gutcOptions.pclSummary&&(options.pcl_summary=nameToUrl["pcl_summary.gct"],null==options.pcl_summary&&(options.pcl_summary=nameToUrl["ps_pcl_summary.gct"])),options.config=nameToUrl["config.yaml"],null==options.config&&gutcUrl.lastIndexOf("UPTAG/")===gutcUrl.length-6&&(options.config=gutcUrl.substring(0,gutcUrl.length-6)+"config.yaml"),null!=options.config&&options.config.indexOf("/arfs/")>-1&&(options.config=options.config.replace("/arfs/","/")),options.columnInfo||(options.columnInfo=nameToUrl["column_meta.txt"]),options.rowInfo=gutcOptions.rowMeta?nameToUrl["row_meta.txt"]:null;var gutcPromise=clue.getGutcResultByUrl(options);gutcPromise.done(function(result){d.resolve(result)}),gutcPromise.fail(function(result){d.reject(result)})}),signedPromise.fail(function(nameToUrl){unsignedResults()})}return d},clue.getSigQueryResults=function(options){var datasetName,sigInfoPromise,filter,p,deferred=$.Deferred(),promises=[],datasets=[],sigInfoLines=null,promise=(datasetName=options.datasetName,sigInfoPromise=$.Deferred(),filter={where:{name:datasetName}},(p=$.ajax(clue.API_URL+"/api/data?filter="+JSON.stringify(filter))).done(function(dataModel){if(dataModel&&dataModel.length>0&&dataModel[0].s3_root){var url="https://s3.amazonaws.com/macchiato.clue.io"+dataModel[0].s3_root+"gutc_background/annot/siginfo.txt",signedUrl=clue.getSignedUrlCache(url);signedUrl.done(function(url){var p=morpheus.Util.readLines(url);p.then(function(result){sigInfoPromise.resolve(result)}),p.catch(function(e){console.log("Could not load siginfo file."),sigInfoPromise.reject()})}),signedUrl.fail(function(){console.log("Could not get signed url."),sigInfoPromise.reject()})}else console.log("Could not find a matching dataset "+datasetName+" with s3_root in API."),sigInfoPromise.reject()}),p.fail(function(){console.log("Failure when querying data endpoint in API."),sigInfoPromise.reject()}),sigInfoPromise);return promises.push(promise),promise.done(function(result){sigInfoLines=result}),options.urls.forEach(function(url,idx){url=clue.fixUrl(url);var promise=morpheus.DatasetUtil.read(url+"/sig.gct");promises.push(promise),promise.then(function(dataset){options.overrideColumns&&Object.keys(options.overrideColumns).forEach(function(key){var colMeta=dataset.getColumnMetadata().getByName(key);colMeta||(colMeta=dataset.getColumnMetadata().add(key));var val=options.overrideColumns[key][idx];val.length;for(var i=0;i<colMeta.size();i++)colMeta.setValue(i,val)});datasets.push(dataset)})}),$.when.apply($,promises).then(function(){var dataset;if(1===datasets.length)dataset=datasets[0];else{for(var i=0;i<datasets.length;i++)datasets[i]=new morpheus.TransposedDatasetView(datasets[i]);dataset=new morpheus.JoinedDataset(datasets[0],datasets[1],"id","id","query");for(i=2;i<datasets.length;i++)dataset=new morpheus.JoinedDataset(dataset,datasets[i],"id","id","query");dataset=new morpheus.TransposedDatasetView(dataset)}if(dataset.setName(options.name),sigInfoLines){const opts={};opts.dataset=dataset,opts.fileColumnNamesToInclude=null,opts.lines=sigInfoLines,opts.isColumns=!1,opts.sets=null,opts.metadataName="id",opts.fileColumnName=sigInfoLines[0].split(/\t/)[0],(new morpheus.OpenFileTool).annotate(opts)}dataset.getColumnMetadata().getByName("id").setName("_id"),deferred.resolve(dataset)},function(){deferred.reject("Unable to read results.")}),(promise=deferred.promise()).toString=function(){return"results"},promise},clue.getGutcResults=function(options){var deferred=$.Deferred(),promises=[],datasets=[];(options=$.extend({},{pclCell:!0,gutcCell:!0,pclSummary:!0,gutcSummary:!0},options)).urls.forEach(function(url,idx){var overrideColumns=null;options.overrideColumns&&(overrideColumns={},Object.keys(options.overrideColumns).forEach(function(key){overrideColumns[key]=options.overrideColumns[key][idx]}));url=clue.fixUrl(url);var promise=clue.getGutcResult({url:url,rowMeta:1===options.urls.length,pclCell:options.pclCell,gutcCell:options.gutcCell,pclSummary:options.pclSummary,gutcSummary:options.gutcSummary,overrideColumns:overrideColumns});promises.push(promise),promise.done(function(dataset){datasets.push(dataset)})});var indexLines=null;if(options.index){options.index=clue.fixUrl(options.index);var indexPromise=$.Deferred(),indexSignedUrl=clue.getSignedUrlCache(options.index);indexSignedUrl.done(function(url){morpheus.Util.readLines(url).then(function(result){indexLines=result,indexPromise.resolve()}).catch(function(){indexPromise.resolve()})}),indexSignedUrl.fail(function(){indexPromise.resolve()}),promises.push(indexPromise)}$.when.apply($,promises).then(function(){for(var dataset,i=0;i<datasets.length;i++){var pclSeriesData=[];datasets[i]=morpheus.DatasetUtil.copy(datasets[i]);for(var j=0,ncols=datasets[i].getRowCount();j<ncols;j++)pclSeriesData.push({});datasets[i].addSeries({name:"PCL",dataType:"number",array:pclSeriesData})}if(1===datasets.length)dataset=datasets[0];else{for(i=0;i<datasets.length;i++)datasets[i]=new morpheus.TransposedDatasetView(datasets[i]);dataset=new morpheus.JoinedDataset(datasets[0],datasets[1],"id","id","query");for(i=2;i<datasets.length;i++)dataset=new morpheus.JoinedDataset(dataset,datasets[i],"id","id","query");dataset=new morpheus.TransposedDatasetView(dataset)}if(dataset.setName(options.name),indexLines){const opts={};opts.dataset=dataset,opts.fileColumnNamesToInclude=null,opts.lines=indexLines,opts.isColumns=!0,opts.sets=null,opts.metadataName="_id",opts.fileColumnName=indexLines[0].split(/\t/)[0],(new morpheus.OpenFileTool).annotate(opts)}deferred.resolve(dataset)},function(){deferred.reject("Unable to read results.")});var promise=deferred.promise();return promise.toString=function(){return"results"},promise},clue.createGutcColorScheme=function(){return{name:"(-100, -95, -90, 90, 95, 100)",scalingMode:"fixed",map:[{value:-100,color:"#0000ff"},{value:-95,color:"#abdda4"},{value:-90,color:"#ffffff"},{value:90,color:"#ffffff"},{value:95,color:"#fdae61"},{value:100,color:"#ff0000"}]}},clue.createLoadingEl=function(text,punctuation){return text||(text="Loading"),punctuation||(punctuation="&#8230;"),$('<div id="loading-spinner" class="loading-box"><div class="loading"><img src="//assets.clue.io/clue/public/img/clueLoadingAnimation.gif"><p class="load-message">&nbsp;'+text+punctuation+"</p></div></div>")},clue.getSignedFolder=function(folder){var d=$.Deferred(),p=$.ajax({context:folder,url:clue.API_URL+"/api/s3_resources/signFolder?s3_folder="+folder});return p.done(function(urls){var fileNameToUrl={};urls.forEach(function(url){var questionMarkIndex=url.indexOf("?");if(-1!==questionMarkIndex){var name=url.substring(0,questionMarkIndex),slashIndex=name.lastIndexOf("/");name=name.substring(slashIndex+1),fileNameToUrl[name]=url}else d.reject("No file name found for "+url)}),d.resolve(fileNameToUrl)}),p.fail(function(){d.reject()}),d},clue.postICVSession=function(options,cb){var heatMap=options.heatMap,json=(options={dataset:!0},heatMap.toJSON(options)),nativeArrayToArray=Array.from||function(typedArray){var normalArray=Array.prototype.slice.call(typedArray);normalArray.length,typedArray.length,normalArray.constructor,Array},inputValues={session:[JSON.stringify(json,function(key,value){return morpheus.Util.isArray(value)?value instanceof Array?value:nativeArrayToArray(value):value})],dataset:"foo",user:"bar"};$.ajax({url:"/icv_session",method:"POST",data:inputValues}).done(function(data){cb(null,data)}).fail(function(err){cb(err)})},clue.getSignedUrlCache=function(url,options){var deferred=$.Deferred(),cacheKey=clue.hashstr(url+clue.USER_KEY);try{var expiry=600;"number"==typeof options?(expiry=options,options=void 0):"object"==typeof options&&(expiry=options.seconds||expiry);var cached=sessionStorage.getItem(cacheKey),whenCached=sessionStorage.getItem(cacheKey+":ts");if(null!==cached&&null!==whenCached){if((Date.now()-whenCached)/1e3<expiry){var sanitizedURL=cached.replace(/"/g,"");return deferred.resolve(sanitizedURL),deferred}sessionStorage.removeItem(cacheKey),sessionStorage.removeItem(cacheKey+":ts")}}catch(ex){console.log(ex)}var myInit={method:"GET",headers:new Headers({user_key:clue.USER_KEY})},r=clue.API_URL+"/api/s3_resources/signFile?s3_file="+url;return fetch(r,myInit).then(function(response){return response.text().then(function(data){if(response.ok)return data;deferred.reject()})}).then(function(signedURL){var sanitizedURL=signedURL.replace(/"/g,"");sessionStorage.setItem(cacheKey,sanitizedURL),sessionStorage.setItem(cacheKey+":ts",Date.now()),deferred.resolve(sanitizedURL)}).catch(function(error){console.log("error:",error),deferred.reject()}),deferred},clue.getSignedUrl=function(url){var r=clue.API_URL+"/api/s3_resources/signFile?s3_file="+url;return $.ajax(r)},clue.txtZipFileFromS3=function(s3_url,callback){var idToItem=new morpheus.Map,baseUrlToIndexLines=new morpheus.Map,promises=[],d=$.Deferred();promises.push(d),clue.getSignedUrlCache(s3_url).done(function(url){morpheus.Util.readLines(url).then(function(lines){baseUrlToIndexLines.set(s3_url,lines),d.resolve()}).catch(function(){d.reject()})}).fail(function(){d.reject()}),$.when.apply($,promises).fail(function(){return callback("An unexpected error occurred. Please try again.")}).done(function(){var lines=baseUrlToIndexLines.get(s3_url);if(null!=lines)for(var tab=/\t/,header=lines[0].split(tab),idField=header[0],i=1,nlines=lines.length;i<nlines;i++){for(var tokens=lines[i].split(tab),item={},j=0;j<header.length;j++){var field=header[j],value=tokens[j];"-666"===value&&(value=""),item[field]=value}var existingItem=idToItem.get(item[idField]);null==existingItem?(existingItem=item,idToItem.set(item[idField],existingItem)):_.extend(existingItem,item);var itemUrl=item.url||item.id;itemUrl&&(null==existingItem.baseUrlToUrls&&(existingItem.baseUrlToUrls=new morpheus.Map),existingItem.baseUrlToUrls.set(s3_url,itemUrl))}var items=idToItem.values();return callback(null,items)}).fail(function(err){return callback(err)})},clue.getJobConfig=function(url){var nameDeferred=$.Deferred(),p=$.ajax({url:url,dataType:"text"}),config={};return p.done(function(text){for(var lines=text.split("\n"),i=0;i<lines.length;i++){var line=lines[i].trim(),index=line.indexOf(":");if(-1!==index){var key=line.substring(0,index).trim(),value=line.substring(index+1).trim();config[key]=value}}nameDeferred.resolve(config)}),p.fail(function(){nameDeferred.resolve(config)}),nameDeferred},clue.getQueryResults=function(options){var datasetPromises=[],connectivityDatasets=[],introspectDatasets=[],inputDatasets=[];options.urls.forEach(function(url){var p;url=clue.fixUrl(url),(p="sig_prot_query_tool"===options.tool?clue.getQueryResultByUrl({baseUrl:url,gct:"CONCATED_CONN.gct"}):clue.getQueryResultByUrl({baseUrl:url,gct:"result_WTCS.CUSTOM.COMBINED_n1x4160.gct"})).done(function(result){connectivityDatasets.push(result.conn),null!=result.introspect&&introspectDatasets.push(result.introspect),null!=result.input&&inputDatasets.push(result.input)}),datasetPromises.push(p)});var d=$.Deferred();return $.when.apply($,datasetPromises).then(function(){var connDatasets=connectivityDatasets[0];if(connectivityDatasets.length>1){for(var joined=new morpheus.JoinedDataset(new morpheus.TransposedDatasetView(connectivityDatasets[0]),new morpheus.TransposedDatasetView(connectivityDatasets[1])),i=2;i<connectivityDatasets.length;i++)joined=new morpheus.JoinedDataset(joined,new morpheus.TransposedDatasetView(connectivityDatasets[i]));connDatasets=new morpheus.TransposedDatasetView(joined)}var inputDataset=null;if(1===inputDatasets.length)inputDataset=inputDatasets[0];else if(inputDatasets.length>1){for(joined=new morpheus.JoinedDataset(new morpheus.TransposedDatasetView(inputDatasets[0]),new morpheus.TransposedDatasetView(inputDatasets[1])),i=2;i<inputDatasets.length;i++)joined=new morpheus.JoinedDataset(joined,new morpheus.TransposedDatasetView(connectivityDatasets[i]));inputDataset=new morpheus.TransposedDatasetView(joined)}d.resolve({conn:connDatasets,introspectDatasets:introspectDatasets,inputDataset:inputDataset})}),d},clue.getQueryResultByUrl=function(options){var dataset=null,introspectDataset=null,inputDataset=null,deferred=$.Deferred(),config={},promises=[],introspectPromise=$.Deferred(),inputPromise=$.Deferred();promises.push(introspectPromise),promises.push(inputPromise),promises.push(clue.getJobConfig(options.baseUrl+"/config.yaml").done(function(conf){if(config=conf,"true"===conf.introspect){var p1=morpheus.DatasetUtil.read(options.baseUrl+"/INTROSPECT_CONN.gct");p1.then(function(d){introspectDataset=d,introspectPromise.resolve()}),p1.finally(function(){introspectPromise.resolve()})}else introspectPromise.resolve();if(null!=conf.input_file){var p2=morpheus.DatasetUtil.read(conf.input_file.replace("http://","https://s3.amazonaws.com/"));p2.then(function(d){inputDataset=d}),p2.finally(function(){inputPromise.resolve()})}else inputPromise.resolve()}));var p=morpheus.DatasetUtil.read(options.baseUrl+"/"+options.gct);return p.then(function(d){dataset=d}),promises.push(p),$.when.apply($,promises).then(function(){if(null!=config.rpt){if(null!=introspectDataset&&(null!=config.assay?introspectDataset.setName(0,"Introspect "+config.assay+" - "+config.rpt):introspectDataset.setName(0,"Introspect - "+config.rpt)),null!=inputDataset){for(var nameVector=inputDataset.getColumnMetadata().add("name"),i=0;i<nameVector.size();i++)nameVector.setValue(i,config.rpt);null!=config.assay?inputDataset.setName(0,"Input "+config.assay+" - "+config.rpt):inputDataset.setName(0,"Input - "+config.rpt)}null==(v=dataset.getColumnMetadata().getByName("name"))&&(v=dataset.getColumnMetadata().add("name"));for(var j=0,size=v.size();j<size;j++)v.setValue(j,config.rpt)}if(null!=config.data_type){var v;null==(v=dataset.getColumnMetadata().getByName("data_type"))&&(v=dataset.getColumnMetadata().add("data_type"));for(j=0,size=v.size();j<size;j++)v.setValue(j,config.data_type)}deferred.resolve({conn:dataset,introspect:introspectDataset,input:inputDataset})}),deferred};var pertTypesTasCache=null,pertTypesTasConfig={trt_oe:{xaxisTitle:"All Gene OE",color:"#27AAE0",lineColor:"#8fc7de"},"trt_sh.cgs":{xaxisTitle:"All Gene KD",color:"#B438BE",lineColor:"#c692ca"},trt_cp:{xaxisTitle:"All Compounds",color:"#F5A623",lineColor:"#edca91"}};clue.promptForFile=function(options){var $modal,d=$.Deferred(),formBuilder=new morpheus.FormBuilder;return formBuilder.append({name:"file",value:"",type:"file",required:!0,multiple:options.multiple}),formBuilder.on("change",function(e){var value=e.value;""!==value&&null!=value&&($modal.modal("hide"),$modal.remove(),d.resolve(value))}),$modal=morpheus.FormBuilder.showInModal({title:"File",html:formBuilder.$form,close:!1}),d},clue.loadTasChart=function(pertId,pertType,tasChartId){$(tasChartElt).empty();var showTasChart=function(pertId,tasChartElt){var getTasHoverData=function(pertName,tas,pertsAbove,pertsBelow){var percentBelow=pertsBelow/(pertsAbove+pertsBelow+1)*100;return{pert:pertName,tas:tas,pertsAbove:pertsAbove,pertsBelow:pertsBelow,percentBelow:percentBelow,percentAbove:100-pertsBelow,percentile:Math.floor(percentBelow)}},makeHoverDiv=function(tasHoverInfo,pertTypeConfig){var percentTable=function(tasHoverInfo,pertTypeConfig){return'<div class="metadata-line"></div><table style="font-size:4pt;width:100%;"><tr><td style="width:'+tasHoverInfo.percentBelow+"%;background-color:"+pertTypeConfig.color+'">&nbsp;</td><td style="background-color:lightgrey;width:'+tasHoverInfo.percentAbove+'%">&nbsp;</tr></table></div>'}(tasHoverInfo,pertTypeConfig),scoreText=function(tasHoverInfo){return tasHoverInfo?'<div><div class="metadata-line"><span class="label">Score:</span><span class="value">'+tasHoverInfo.tas+'</span></div><div class="metadata-line"><span class="label">Percentile:</span><span class="value">'+tasHoverInfo.percentile+"</span></div></div>":""}(tasHoverInfo);return'<div class="graph-title">'+tasHoverInfo.pert+"<br/>"+percentTable+scoreText+"</div>"};if(pertTypesTasCache[pertType]){var tasForPert=pertTypesTasCache[pertType].tasForPertId[pertId],xAxisTitle=pertTypesTasConfig[pertType].xaxisTitle+" ("+pertTypesTasCache[pertType].tasX.length+")",lineColor=(tasChartElt=document.getElementById(tasChartId),pertTypesTasConfig[pertType].lineColor);Plotly.newPlot(tasChartElt,[{x:pertTypesTasCache[pertType].tasX,y:pertTypesTasCache[pertType].tasY,text:pertTypesTasCache[pertType].pert_iname,hoverinfo:"none",mode:"lines",type:"scatter",marker:{color:lineColor}}],{margin:{t:10,b:20,l:30,r:0},hovermode:"closest",showlegend:!1,xaxis:{showline:!0,zeroline:!1,showticklabels:!1,ticks:"",fixedrange:!0,range:[0,pertTypesTasCache[pertType].tasX.length],title:xAxisTitle,showgrid:!1,titlefont:{family:"Roboto Condensed, sans-serif"}},yaxis:{range:[0,1],dtick:.25,showline:!0,zeroline:!1,fixedrange:!0,ticksuffix:" ",titlefont:{family:"Roboto Condensed, sans-serif"}}},{displayModeBar:!1}).then(function(){if(tasForPert){var pertsAbove=pertTypesTasCache[pertType].tasX.length;!function(x,y,pertName,pertsAbove,pertsBelow){var pertTypeConfig=pertTypesTasConfig[pertType];$(tasChartElt).find("#tas_point_info").remove(),$(tasChartElt).append('<div id="tas_point_info" style="width:40%;position:relative;top:-90%;right:-50%;"></div>'),Plotly.addTraces(tasChartElt,{mode:"lines+markers",x:[x],y:[y],hoverinfo:"none",name:pertName,marker:{color:pertTypeConfig.color,size:10},hovermode:"closest"}).then(function(){var tasHoverInfoElt=$(tasChartElt).find("#tas_point_info");tasChartElt.on("plotly_hover",function(data){tasHoverInfoElt.empty();var infotext=data.points.map(function(d){var tasHoverInfo=void 0;return d.data.text?(tasHoverInfo=getTasHoverData(d.data.text[d.x],d.y,d.x,d.data.x.length-d.x-1),makeHoverDiv(tasHoverInfo,pertTypeConfig)):""});tasHoverInfoElt.append(infotext)}).on("plotly_unhover",function(data){tasHoverInfoElt.empty();var tasHoverInfo=getTasHoverData(pertName,y,pertsAbove,pertsBelow);tasHoverInfoElt.append(makeHoverDiv(tasHoverInfo,pertTypeConfig))}),tasHoverInfoElt.empty();var tasHoverInfo=getTasHoverData(pertName,y,pertsAbove,pertsBelow);tasHoverInfoElt.append(makeHoverDiv(tasHoverInfo,pertTypeConfig))})}(tasForPert.tasX,tasForPert.tasY,tasForPert.pert_iname,tasForPert.tasX,pertsAbove-tasForPert.tasX-1)}else console.log("No tas data available for "+pertId)})}else console.log("unknown pert type "+pertType+".  Cannot show tas curve.")},tasChartElt=document.getElementById(tasChartId);pertTypesTasCache?showTasChart(pertId,tasChartElt):clue.getTranscriptionalImpactForAllTouchstonePerts(function(error,tasScores){}).done(function(tasScores){for(var pertType in tasCache={},pertTypesTasCache={},pertTypesTasConfig)pertTypesTasCache[pertType]={tasX:[],tasY:[],pert_id:[],pert_iname:[],tasForPertId:{},xIndex:0};tasScores.forEach(function(tas,index){if(tasCache[tas.pert_id]=tas.pert_type,pertTypesTasCache[tas.pert_type]){var tasForPertType=pertTypesTasCache[tas.pert_type];tasForPertType.tasX.push(tasForPertType.xIndex),tasForPertType.tasY.push(tas.tas),tasForPertType.pert_id.push(tas.pert_id),tasForPertType.pert_iname.push(tas.pert_iname),tasForPertType.tasForPertId[tas.pert_id]={tasX:tasForPertType.xIndex,tasY:tas.tas,pert_iname:tas.pert_iname,pert_type:tas.pert_type},tasForPertType.xIndex++}else console.log("No tas cache for "+tas.pert_type)}),showTasChart(pertId,tasChartElt)})},clue.getGutcResultByUrl=function(options){var idSummary,idCellSummary,pclCell,pclSummary,sigGCT,p,deferred=$.Deferred(),promises=[];null!=options.sig_gct&&(p=morpheus.DatasetUtil.read(options.sig_gct),promises.push(p),p.then(function(d){sigGCT=d})),null!=options.pert_id_summary&&(p=morpheus.DatasetUtil.read(options.pert_id_summary),promises.push(p),p.then(function(d){idSummary=d})),null!=options.pert_id_cell&&(p=morpheus.DatasetUtil.read(options.pert_id_cell),promises.push(p),p.then(function(d){idCellSummary=d})),null!=options.pcl_cell&&(p=morpheus.DatasetUtil.read(options.pcl_cell),promises.push(p),p.then(function(d){pclCell=d}),p.catch(function(d){console.log("Error reading PCL cell at "+options.pcl_cell)})),null!=options.pcl_summary&&(p=morpheus.DatasetUtil.read(options.pcl_summary),promises.push(p),p.then(function(d){pclSummary=d}),p.catch(function(d){console.log("Error reading PCL summary at "+options.pcl_summary)}));var annotationLines=null;null!=options.columnInfo&&(p=morpheus.Util.readLines(options.columnInfo)).then(function(lines){annotationLines=lines});var rowAnnotationLines=null;null!=options.rowInfo&&(p=morpheus.Util.readLines(options.rowInfo),promises.push(p),p.then(function(lines){rowAnnotationLines=lines}));var queryName=null;if(null!=options.config){var nameDeferred=$.Deferred();(p=$.ajax({url:options.config})).done(function(text){for(var lines=text.split("\n"),i=0;i<lines.length;i++){var line=lines[i];if(0===line.indexOf("rpt:")){queryName=$.trim(line.substring(4));break}}}),p.always(function(){nameDeferred.resolve()}),promises.push(nameDeferred)}function addUniqueId(d){for(var uniqueIdVector=d.getColumnMetadata().add("_id"),idVector=d.getColumnMetadata().getByName("id"),cellVector=d.getColumnMetadata().getByName("cell_id"),i=0,size=idVector.size();i<size;i++)uniqueIdVector.setValue(i,idVector.getValue(i)+"-"+cellVector.getValue(i));return uniqueIdVector}return Promise.all(promises).then(function(){var counter=0,cellDataset=null;if(idCellSummary){for(var queryIdVectorLong=idCellSummary.getColumnMetadata().getByName("id"),pertIdVectorLong=idCellSummary.getRowMetadata().getByName("id"),cellIdVectorLong=idCellSummary.getRowMetadata().add("cell_id"),uniqueCells=new morpheus.Set,uniquePerts=new morpheus.Set,i=0,nrows=idCellSummary.getRowCount();i<nrows;i++){var index=(id=pertIdVectorLong.getValue(i)).lastIndexOf(":"),cell=id.substring(index+1);id=id.substring(0,index),pertIdVectorLong.setValue(i,id),cellIdVectorLong.setValue(i,cell),uniquePerts.add(id),uniqueCells.add(cell)}idSummary&&uniqueCells.add("summary");var pertIdVector=(cellDataset=new morpheus.Dataset({name:"",rows:uniquePerts.size(),columns:uniqueCells.size()*idCellSummary.getColumnCount()})).getRowMetadata().add("id");counter=0,uniquePerts.forEach(function(id){pertIdVector.setValue(counter++,id)});for(var cellVector=cellDataset.getColumnMetadata().add("cell_id"),queryIdVector=cellDataset.getColumnMetadata().add("id"),nqueries=idCellSummary.getColumnCount(),cells=uniqueCells.values(),ncells=cells.length,j=0;j<nqueries;j++)for(var queryId=queryIdVectorLong.getValue(j),size=(i=0,cellVector.size());i<size;i++)cellVector.setValue(j*ncells+i,cells[i]),queryIdVector.setValue(j*ncells+i,queryId);var pertIdToIndex=morpheus.VectorUtil.createValueToIndexMap(pertIdVector),uniqueIdToIndex=morpheus.VectorUtil.createValueToIndexMap(addUniqueId(cellDataset));morpheus.DatasetUtil.fill(cellDataset,NaN);for(j=0;j<nqueries;j++)for(queryId=queryIdVectorLong.getValue(j),i=0,nrows=idCellSummary.getRowCount();i<nrows;i++){var cellId=cellIdVectorLong.getValue(i),pertId=pertIdVectorLong.getValue(i),rowIndex=pertIdToIndex.get(pertId),columnIndex=uniqueIdToIndex.get(queryId+"-"+cellId);cellDataset.setValue(rowIndex,columnIndex,idCellSummary.getValue(i,j))}if(idSummary){for(i=0,size=(cellIdVectorLong=idSummary.getRowMetadata().add("cell_id")).size();i<size;i++)cellIdVectorLong.setValue(i,"summary");queryIdVectorLong=idSummary.getColumnMetadata().getByName("id"),pertIdVectorLong=idSummary.getRowMetadata().getByName("id");for(j=0;j<nqueries;j++)for(queryId=queryIdVectorLong.getValue(j),i=0,nrows=idSummary.getRowCount();i<nrows;i++){cellId=cellIdVectorLong.getValue(i),pertId=pertIdVectorLong.getValue(i),rowIndex=pertIdToIndex.get(pertId),columnIndex=uniqueIdToIndex.get(queryId+"-"+cellId);if(void 0===rowIndex)throw"error";if(void 0===columnIndex)throw"error";cellDataset.setValue(rowIndex,columnIndex,idSummary.getValue(i,j))}}}else if(idSummary){for(j=0,size=(cellVector=(cellDataset=idSummary).getColumnMetadata().add("cell_id")).size();j<size;j++)cellVector.setValue(j,"summary");addUniqueId(cellDataset)}if(pclSummary){1===pclSummary.getRowCount()&&(pclSummary=new morpheus.TransposedDatasetView(pclSummary));var pclSummaryRowIds=pclSummary.getRowMetadata().getByName("id");for(i=0;i<pclSummaryRowIds.size();i++){-1!==(index=(id=pclSummaryRowIds.getValue(i)).lastIndexOf(":"))&&pclSummaryRowIds.setValue(i,id.substring(0,index))}for(j=0,size=(cellVector=pclSummary.getColumnMetadata().add("cell_id")).size();j<size;j++)cellVector.setValue(j,"summary");addUniqueId(pclSummary)}if(null!=pclCell){var pclIdVector=pclCell.getRowMetadata().getByName("id"),pclCellVector=pclCell.getRowMetadata().add("cell_id");for(i=0,size=pclCellVector.size();i<size;i++){index=(id=pclIdVector.getValue(i)).lastIndexOf(":");pclIdVector.setValue(i,id.substring(0,index)),pclCellVector.setValue(i,id.substring(index+1))}if(1==pclCell.getColumnCount()||"CP_ATPASE_INHIBITOR"!==pclCell.getColumnMetadata().getByName("id").getValue(0)){var uniquePcls=new morpheus.Set;for(uniqueCells=new morpheus.Set,i=0,size=pclCellVector.size();i<size;i++){cell=pclCellVector.getValue(i);var id=pclIdVector.getValue(i);uniqueCells.add(cell);var pcl=pclIdVector.getValue(i);uniquePcls.add(pcl)}nqueries=pclCell.getColumnCount();var pivotedDataset=new morpheus.Dataset({name:"",rows:uniquePcls.size(),columns:uniqueCells.size()*nqueries});morpheus.DatasetUtil.fill(pivotedDataset,NaN);var pivotedRowIdVector=pivotedDataset.getRowMetadata().add("id");counter=0,uniquePcls.forEach(function(pcl){pivotedRowIdVector.setValue(counter++,pcl)});var pclIdToIndex=morpheus.VectorUtil.createValueToIndexMap(pivotedRowIdVector),pivotedColumnIdVector=pivotedDataset.getColumnMetadata().add("id"),pivotedColumnCellIdVector=pivotedDataset.getColumnMetadata().add("cell_id"),cellArray=(queryIdVector=pclCell.getColumnMetadata().getByName("id"),uniqueCells.values());counter=0;for(j=0;j<nqueries;j++)for(queryId=queryIdVector.getValue(j),i=0;i<cellArray.length;i++){cellId=cellArray[i];pivotedColumnIdVector.setValue(counter,queryId),pivotedColumnCellIdVector.setValue(counter,cellId),counter++}for(uniqueIdToIndex=morpheus.VectorUtil.createValueToIndexMap(addUniqueId(pivotedDataset)),j=0;j<nqueries;j++)for(queryId=queryIdVector.getValue(j),i=0,size=pclCellVector.size();i<size;i++){cell=pclCellVector.getValue(i),columnIndex=uniqueIdToIndex.get(queryId+"-"+cell),rowIndex=pclIdToIndex.get(pclIdVector.getValue(i));pivotedDataset.setValue(rowIndex,columnIndex,pclCell.getValue(i,j))}pclCell=pivotedDataset}else addUniqueId(pclCell=new morpheus.TransposedDatasetView(pclCell));null!=pclSummary&&(pclCell=new morpheus.TransposedDatasetView(new morpheus.JoinedDataset(new morpheus.TransposedDatasetView(pclCell),new morpheus.TransposedDatasetView(pclSummary),"id","id")));var pclPertTypeVector=pclCell.getRowMetadata().add("type");for(i=0,size=pclPertTypeVector.size();i<size;i++)pclPertTypeVector.setValue(i,"PCL");cellDataset=cellDataset?new morpheus.JoinedDataset(cellDataset,pclCell,"_id","_id"):pclCell}else null!=pclSummary&&(cellDataset=cellDataset?new morpheus.JoinedDataset(cellDataset,pclSummary,"id","id"):pclSummary);if(cellDataset||(cellDataset=sigGCT),cellDataset.getRowMetadata()){var sourceIndex=morpheus.MetadataUtil.indexOf(cellDataset.getRowMetadata(),"Source");-1!==sourceIndex&&cellDataset.getRowMetadata().remove(sourceIndex)}var opts,tmp,mergedDataset=cellDataset,pertDoseVector=mergedDataset.getColumnMetadata().getByName("pert_idose");if(pertDoseVector)for(i=0,size=pertDoseVector.size();i<size;i++){var value=""+pertDoseVector.getValue(i);pertDoseVector.setValue(i,value.replace("um","µm"))}annotationLines&&((opts={}).dataset=mergedDataset,opts.fileColumnNamesToInclude=null,opts.lines=annotationLines,opts.isColumns=!0,opts.sets=null,opts.metadataName="id",opts.fileColumnName=annotationLines[0].split(/\t/)[0],(new morpheus.OpenFileTool).annotate(opts));rowAnnotationLines&&((opts={}).dataset=mergedDataset,opts.fileColumnNamesToInclude=null,opts.lines=rowAnnotationLines,opts.isColumns=!1,opts.sets=null,opts.metadataName="id",opts.fileColumnName=rowAnnotationLines[0].split(/\t/)[0],(new morpheus.OpenFileTool).annotate(opts));if(null!=queryName){var nameVector=mergedDataset.getColumnMetadata().getByName("name");nameVector||(nameVector=mergedDataset.getColumnMetadata().add("name"));for(j=0;j<nameVector.size();j++)nameVector.setValue(j,queryName)}for(var columns=[],ncols=(j=0,mergedDataset.getColumnCount());j<ncols;j++)for(i=0,nrows=mergedDataset.getRowCount();i<nrows;i++)if(!isNaN(mergedDataset.getValue(i,j))){columns.push(j);break}((tmp=(mergedDataset=columns.length!==mergedDataset.getColumnCount()?new morpheus.SlicedDatasetView(mergedDataset,null,columns):mergedDataset).getColumnMetadata().getByName("_id"))&&tmp.setName("id"),(tmp=mergedDataset.getColumnMetadata().getByName("id"))&&tmp.setName("_id"),options.overrideColumns)&&Object.keys(options.overrideColumns).forEach(function(key){var colMeta=mergedDataset.getColumnMetadata().getByName(key);colMeta||(colMeta=mergedDataset.getColumnMetadata().add(key));for(var val=options.overrideColumns[key],i=0;i<colMeta.size();i++)colMeta.setValue(i,val)});deferred.resolve(mergedDataset)},function(err){console.log("Unable to read GUTC results. Error: "+err),deferred.reject("Unable to read GUTC results.")}),deferred.promise()},clue.newPlot=function(myPlot,traces,layout,config){Plotly.newPlot(myPlot,traces,layout,config);var $a=$('<a data-toggle="tooltip" title="Toggle mode bar" href="#" style="fill: rgb(68, 122, 219);position: absolute;top: -2px;right:-6px;z-index: 1002;"><svg height="1em" width="1em" viewBox="0 0 1542 1000"><path d="m0-10h182v-140h-182v140z m228 146h183v-286h-183v286z m225 714h182v-1000h-182v1000z m225-285h182v-715h-182v715z m225 142h183v-857h-183v857z m231-428h182v-429h-182v429z m225-291h183v-138h-183v138z" transform="matrix(1 0 0 -1 0 850)"></path></svg></a>'),$myPlot=$(myPlot);$a.appendTo($myPlot);var $modeBar=$(myPlot).find(".modebar");$modeBar.css("display","none"),$a.on("click",function(e){e.preventDefault(),$modeBar.toggle()})},clue.getPlotlyDefaults2=function(){var plotly=clue.getPlotlyDefaults();return plotly.layout.width=600,plotly.layout.height=600,plotly.layout.margin={l:40,r:10,t:40,b:40,autoexpand:!0},delete plotly.config.displayModeBar,plotly},clue.BUTTONS_TO_REMOVE_FOR_STATIC_CHART=["select2d","lasso2d"],clue.getPlotlyDefaults=function(){return{layout:{hovermode:"closest",autosize:!0,showlegend:!1,margin:{l:80,r:10,t:8,b:14,autoexpand:!0},titlefont:{size:12},xaxis:{zeroline:!1,titlefont:{size:12},showgrid:!0,showticklabels:!0,tickcolor:"rgb(127,127,127)",ticks:"outside"},yaxis:{zeroline:!1,titlefont:{size:12},showgrid:!0,showticklabels:!0,tickcolor:"rgb(127,127,127)",ticks:"outside"}},config:{modeBarButtonsToAdd:[],showLink:!1,displayModeBar:!0,displaylogo:!1,staticPlot:!1,showHints:!0,modeBarButtonsToRemove:["sendDataToCloud","zoomIn2d","zoomOut2d","hoverCompareCartesian","hoverClosestCartesian"]}}};